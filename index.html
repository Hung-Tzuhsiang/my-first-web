<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè¨˜å¸³ç³»çµ±</title>
    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; font-weight: 800; }
        
        label { display: block; margin-top: 12px; color: #555; font-size: 0.95em; font-weight: bold; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; box-sizing: border-box; border: 1px solid #ccc; font-size: 16px; }
        
        select { background-color: #f8f9fa; cursor: pointer; }
        input:focus, select:focus { border-color: #1a73e8; outline: none; box-shadow: 0 0 5px rgba(26,115,232,0.2); }
        
        button { background-color: #1a73e8; color: white; border: none; font-weight: bold; margin-top: 25px; cursor: pointer; transition: 0.2s; font-size: 1.1em; padding: 14px; }
        button:hover { background-color: #1557b0; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="card">
        <h2>ğŸ“’ é›²ç«¯è¨˜å¸³æœ¬</h2>
        <form id="accountingForm">
            
            <label>ğŸ“… æ—¥æœŸ</label>
            <input type="date" name="date" id="dateInput" required>

            <label>ğŸ“‚ å¤§é …åˆ†é¡</label>
            <select name="main_cat" id="mainCat" required onchange="updateSubCat()">
                <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
            </select>

            <div id="subCatGroup">
                <label>ğŸ·ï¸ ç´°é …åˆ†é¡</label>
                <select name="sub_cat" id="subCat">
                    <option value="" disabled selected>è«‹å…ˆé¸å¤§é …...</option>
                </select>
            </div>

            <label>ğŸ“ å…§å®¹èªªæ˜ (å¿…å¡«)</label>
            <input type="text" name="content" placeholder="ä¾‹å¦‚: åˆé¤ã€åˆ©æ¯ã€æ±½è»Šä¿é¤Š" required>

            <label>ğŸ’² é‡‘é¡</label>
            <input type="number" name="price" placeholder="è¼¸å…¥é‡‘é¡ (è‡ªå‹•åˆ¤æ–·æ­£è² )" required inputmode="numeric">

            <label>ğŸ“ å‚™è¨» (é¸å¡«)</label>
            <input type="text" name="note" placeholder="è£œå……èªªæ˜...">

            <button type="submit" id="submitBtn">é€å‡ºç´€éŒ„</button>
            <div class="loader" id="loader"></div>
        </form>
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è«‹æ›æˆä½ çš„æ–°ç‰ˆ Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
        const scriptURL = 'https://script.google.com/macros/s/ä½ çš„é‚£ä¸€é•·ä¸²ID/exec';

        document.getElementById('dateInput').valueAsDate = new Date();
        let categories = {};

        // 1. è¼‰å…¥é¸å–®
        window.onload = function() {
            const mainSelect = document.getElementById("mainCat");
            fetch(scriptURL)
                .then(response => response.json())
                .then(data => {
                    categories = data;
                    mainSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
                    for (let main in categories) {
                        let opt = document.createElement("option");
                        opt.value = main;
                        opt.innerText = main;
                        mainSelect.appendChild(opt);
                    }
                })
                .catch(error => {
                    alert("é¸å–®è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯ï¼");
                    mainSelect.innerHTML = '<option value="" disabled>è¼‰å…¥å¤±æ•—</option>';
                });
        };

        // 2. é€£å‹•é¸å–®
        function updateSubCat() {
            const main = document.getElementById("mainCat").value;
            const subSelect = document.getElementById("subCat");
            const subGroup = document.getElementById("subCatGroup");

            subSelect.innerHTML = "";

            if (!categories[main] || categories[main].length === 0) {
                subGroup.style.display = "none";
                subSelect.removeAttribute("required");
                let opt = document.createElement("option");
                opt.value = "-";
                opt.selected = true;
                subSelect.appendChild(opt);
            } else {
                subGroup.style.display = "block";
                subSelect.setAttribute("required", "");
                let defaultOpt = document.createElement("option");
                defaultOpt.text = "è«‹é¸æ“‡ç´°é …...";
                defaultOpt.value = "";
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                subSelect.appendChild(defaultOpt);

                categories[main].forEach(optText => {
                    let el = document.createElement("option");
                    el.value = optText;
                    el.innerText = optText;
                    subSelect.appendChild(el);
                });
            }
        }

        // 3. é€å‡ºè¡¨å–®
        const form = document.forms['accountingForm'];
        const btn = document.getElementById('submitBtn');
        const loader = document.getElementById('loader');

        form.addEventListener('submit', e => {
            e.preventDefault();
            btn.style.display = 'none';
            loader.style.display = 'block';

            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(response => {
                    alert('âœ… è¨˜å¸³æˆåŠŸï¼');
                    form.reset(); 
                    document.getElementById('dateInput').valueAsDate = new Date();
                    document.getElementById("subCatGroup").style.display = "block";
                    document.getElementById("subCat").innerHTML = "<option value='' disabled selected>è«‹å…ˆé¸å¤§é …...</option>";
                })
                .catch(error => {
                    alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼');
                })
                .finally(() => {
                    btn.style.display = 'block';
                    loader.style.display = 'none';
                });
        });
    </script>
</body>
</html>
